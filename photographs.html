<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta name="description" content="'Build the Future with 10,000 Tuvaluans' by NPO Tuvalu Overview is an archiving project of portraits of people in Tuvalu. We made visualization of this archive on Google Earth, and constructed the communication system that users can transmit the message to people in Tuvalu."
	/>
	<meta property="og:image" content="data/screenShot2.jpg" />
	<meta property="og:description" content="'Build the Future with 10,000 Tuvaluans' by NPO Tuvalu Overview is an archiving project of portraits of people in Tuvalu. We made visualization of this archive on Google Earth, and constructed the communication system that users can transmit the message to people in Tuvalu."
	/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<title>Tuvalu Visualization Project</title>
	<link rel="SHORTCUT ICON" href="data/favicon.ico">
	<link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.138/Build/Cesium/Widgets/widgets.css" />
	<link rel="stylesheet" type="text/css" media="all" href="./css/style.css" />
	<link rel="stylesheet" type="text/css" media="all" href="./css/menubutton.css" />
	<script src="js/jquery-2.1.3.min.js"></script>
	<script src="js/slidein.js"></script>
	<script src="https://cesium.com/downloads/cesiumjs/releases/1.138/Build/Cesium/Cesium.js"></script>
	<script src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyCc9E-ulJKRVMPyJe_V5sUVNU8kxiDIUtg&loading=async"></script>
	<script type="text/javascript">
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-55397811-7', 'auto');
		ga('send', 'pageview');
	</script>
</head>

<body>
	<div id="blackOut">
		<img class="loading" src="data/loading.gif">
	</div>
	<div id="cesiumContainer"></div>
	<div id="originalInfoBox"></div>
	<div id="originalInfoBoxConnector"></div>
	<!--
<div id="timeCounter"></div>
-->
	<div id="button" class="general-button">
		<div class="button-content">
			<span class="icon-font">menu</span>
		</div>
	</div>
	<div id="button2" class="general-button" onclick="face();">
		<div class="button-content">
			<span class="icon-font">user</span>
		</div>
	</div>
	<div id="button3" class="general-button" onclick="help();">
		<div class="button-content">
			<span class="icon-font">help</span>
		</div>
	</div>
	<div id="slide_menu"></div>
	<div id="slide_menu2"></div>
	<script>

//URLパラメータ取得

var urlParameter = new Object;
var pair=location.search.substring(1).split('&');
for(var i=0;pair[i];i++) {
	var parameter = pair[i].split('=');
	urlParameter[parameter[0]]=parameter[1];
}

//オーバレイ用グローバル変数

var openStreetMap = {};
var overlayDataArray=[];

//KML変数、CZML配列作成関数

var tuvaluStarKml = 'data/star.kml';

function czmlData(_label, _url) {
	this.label = _label;
	this.url = _url;
}

var czmlDataArray=[];
czmlDataArray[0]=new czmlData("funafuti",'data/photographs/funafuti.czml');
czmlDataArray[1]=new czmlData("nukufetau_atoll",'data/photographs/nukufetau_atoll.czml');
czmlDataArray[2]=new czmlData("nukufetau_island",'data/photographs/nukufetau_island.czml');
czmlDataArray[3]=new czmlData("vaitupu",'data/photographs/vaitupu.czml');

//機種判別，画面サイズによる画面レイアウト変更

var mobile = 0;
var smallScreen = 0;

var getDevice = (function(){
	var ua = navigator.userAgent;
	if(ua.indexOf('iPhone') > 0 || ua.indexOf('iPod') > 0 || ua.indexOf('Android') > 0 && ua.indexOf('Mobile') > 0){
		mobile = 1;
	}else if(ua.indexOf('iPad') > 0 || ua.indexOf('Android') > 0){
		mobile = 2;
	}else{
		mobile = 0;
	}
})();

var screenWidth = window.parent.screen.width;
if (screenWidth <= 640) {
	smallScreen = 1;
} else {
	smallScreen = 0;
}

if (smallScreen == 0) {
	$(function() {
		$('#timeCounter').css('bottom','16px');
		$('#timeCounter').css('font-size','22px');
		$('#timeCounter').css('line-height','22px');
	});
}

$(window).on('resize', function(){
	setTimeout('widgetsInit()',100);
});

//画面サイズ調整

if (mobile != 1) {
    setTimeout('resizeWindow()',0);
} else {
    $('.titleImage').css('width','100%');
    setTimeout('resizeWindow()',1000);
}

function resizeWindow(){
    if (mobile != 0){
        var screenWidth = window.innerWidth;
        var screenHeight = window.innerHeight;
        $(function() {
            document.body.style.height = screenHeight;
            $('#cesiumContainer').height(screenHeight);
            $('#blackOut').height(screenHeight);
        });
    }
    setTimeout('loadCesium()',100);
}

//ローディングDIV

var blackOutDiv = document.getElementById("blackOut");

function blackOut(param) {
	if (param == 0){
		$(function() {
			$(blackOutDiv).fadeOut("slow");
		});
	} else {
		$(function() {
			$(blackOutDiv).fadeIn("slow");
		});
	}
}

//視点配列生成

function viewPoints(_label, _lat, _lng, _heading, _pitch, _range) {
	this.label = _label;
	this.lat = _lat;
	this.lng = _lng;
	this.heading = _heading;
	this.pitch = _pitch;
	this.range = _range;
}

var viewPointsArray=[];
viewPointsArray[0]=new viewPoints("Vaitupu",-7.486733,178.679767,0,-30,4800);
viewPointsArray[1]=new viewPoints("Nukufetau",-8.030447,178.312297,0,-30,1800);
viewPointsArray[2]=new viewPoints("Funafuti",-8.520560,179.195245,0,-30,2500);
viewPointsArray[3]=new viewPoints("Tuvalu",-7.508104,178.024189,0,-89,1000000);
viewPointsArray[4]=new viewPoints("Earth",-7.508104,178.024189,0,-89,8000000);

var viewPointChangeMenu = document.getElementById('slide_menu');
var dropDownList = "";

for (var i=0; i<viewPointsArray.length; i++) {
	dropDownList = dropDownList + '<li><a href="#" onclick = "changeViewPoint(' + i + ',' + '4.0);return false;">' + viewPointsArray[i].label + '</a></li>';
}

var viewPointChangeMenuHtml = '<ul class="viewpoint">' + dropDownList + '</ul>';
viewPointChangeMenu.innerHTML = viewPointChangeMenuHtml;

//ビューア初期化

var viewer;
var scene;
var infoWindowPosition;
var pickedHandler;
var infoBoxConnector = document.getElementById('originalInfoBoxConnector');

function hideOriginalInfoBox() {
	infoWindowPosition = null;
	$('#originalInfoBox').hide();
	infoBoxConnector.style.display = 'none';
}

function updateOriginalInfoBoxConnector(anchorPosition, infoBox) {
	var anchorX = Number(anchorPosition.x);
	var anchorY = Number(anchorPosition.y);
	if (!isFinite(anchorX) || !isFinite(anchorY)) {
		infoBoxConnector.style.display = 'none';
		return;
	}
	var rect = infoBox.getBoundingClientRect();
	var targetX = Math.max(rect.left, Math.min(anchorX, rect.right));
	var targetY = Math.max(rect.top, Math.min(anchorY, rect.bottom));
	var dx = targetX - anchorX;
	var dy = targetY - anchorY;
	var length = Math.sqrt(dx * dx + dy * dy);

	if (!isFinite(length) || length <= 0) {
		infoBoxConnector.style.display = 'none';
		return;
	}

	infoBoxConnector.style.width = length + 'px';
	infoBoxConnector.style.left = anchorX + 'px';
	infoBoxConnector.style.top = anchorY + 'px';
	infoBoxConnector.style.transform = 'rotate(' + Math.atan2(dy, dx) + 'rad)';
	infoBoxConnector.style.display = 'block';
}

function updateOriginalInfoBoxPosition() {
	if (!infoWindowPosition) {
		return;
	}
	var canvasPosition = Cesium.SceneTransforms.worldToWindowCoordinates(scene, infoWindowPosition);
	if (!Cesium.defined(canvasPosition)) {
		$('#originalInfoBox').hide();
		infoBoxConnector.style.display = 'none';
		return;
	}
	var infoBox = document.getElementById('originalInfoBox');
	var margin = 8;
	var gapX = 18;
	var gapY = 24;
	var maxLeft = window.innerWidth - infoBox.offsetWidth - margin;
	var maxTop = window.innerHeight - infoBox.offsetHeight - margin;
	var preferredLeft = canvasPosition.x + gapX;
	var fallbackLeft = canvasPosition.x - infoBox.offsetWidth - gapX;
	var preferredTop = canvasPosition.y - infoBox.offsetHeight - gapY;
	var fallbackTop = canvasPosition.y + gapY;
	var left;
	var top;

	if (preferredLeft <= maxLeft) {
		left = preferredLeft;
	} else if (fallbackLeft >= margin) {
		left = fallbackLeft;
	} else {
		left = Math.max(margin, Math.min(preferredLeft, maxLeft));
	}

	if (preferredTop >= margin) {
		top = preferredTop;
	} else if (fallbackTop <= maxTop) {
		top = fallbackTop;
	} else {
		top = Math.max(margin, Math.min(fallbackTop, maxTop));
	}

	infoBox.style.left = left + 'px';
	infoBox.style.top = top + 'px';
	updateOriginalInfoBoxConnector(canvasPosition, infoBox);
}

function showOriginalInfoBox(position, html) {
	infoWindowPosition = position;
	$('#originalInfoBox').html(html).show();
	updateOriginalInfoBoxPosition();
}

function normalizePhotoBillboards(dataSource) {
	var entities = dataSource.entities.values;
	for (var j = 0; j < entities.length; j++) {
		var entity = entities[j];
		if (!entity.billboard) {
			continue;
		}
		entity.billboard.heightReference = new Cesium.ConstantProperty(Cesium.HeightReference.CLAMP_TO_GROUND);
		entity.billboard.disableDepthTestDistance = new Cesium.ConstantProperty(Number.POSITIVE_INFINITY);
	}
}

function getPickedPosition(element) {
	if (element.id && element.id.position && typeof element.id.position.getValue === 'function') {
		return element.id.position.getValue(viewer.clock.currentTime);
	}
	if (element.primitive && element.primitive.position) {
		return element.primitive.position;
	}
	return null;
}

function buildPickedInfoHtml(element) {
	var name = element.id && element.id.name ? element.id.name : '';
	var safeName = $('<div>').text(name).html();
	var descriptionHtml = '';
	if (element.id && element.id.description && typeof element.id.description.getValue === 'function') {
		descriptionHtml = element.id.description.getValue(viewer.clock.currentTime) || '';
	}
	return (safeName ? '<p class="nameAndAge">' + safeName + '</p>' : '') + '<div class="infoBoxContent">' + descriptionHtml + '</div>';
}

function loadCesium(){
	Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzZjdkOGRkYi1hYzIxLTQ4MDMtYjZiMC0zODg5YjI2ZTRlZjIiLCJpZCI6MjgyLCJzY29wZXMiOlsiYXNsIiwiYXNyIiwiYXN3IiwiZ2MiXSwiaWF0IjoxNTYyMDEyNTIyfQ.aVsGtowVeK_5C25G5-WCK7bZHyfXUl_zQ5Ud7TKsq0U';
    viewer = new Cesium.Viewer('cesiumContainer',{
		infoBox: false,
		selectionIndicator: false,
        navigationHelpButton : false,
        navigationInstructionsInitiallyVisible : false,
        timeline: false,
        animation: false,
        geocoder:false,
        sceneModePicker:false,
        baseLayerPicker:false,
        scene3DOnly : true,
		requestRenderMode : true,
		maximumRenderTimeChange : Infinity
    });

    scene = viewer.scene;
	scene.globe.depthTestAgainstTerrain = false;
	viewer.scene.postRender.addEventListener(updateOriginalInfoBoxPosition);
	pickedHandler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
	pickedHandler.setInputAction(function (movement) {
		var element = scene.pick(movement.position);
		if (!element) {
			hideOriginalInfoBox();
			return;
		}
		var position = getPickedPosition(element);
		if (!position) {
			hideOriginalInfoBox();
			return;
		}
		showOriginalInfoBox(position, buildPickedInfoHtml(element));
	}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    //ダブルクリック操作を不可に

    viewer.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

    //devicePixelRatioの設定
    /*
    if(Cesium.FeatureDetection.supportsImageRenderingPixelated()){
        viewer.resolutionScale = window.devicePixelRatio;
    }
    */
    //フォグ
    /*
    var fog = new Cesium.Fog();
    fog.density = 0.003;
    fog.screenSpaceErrorFactor = 100.0;
    */
    //起動シークエンス

    $(function() {
    //	$('.cesium-viewer-animationContainer').fadeOut(0);
    //	$('.cesium-viewer-timelineContainer').fadeOut(0);
        $('#button').fadeOut(0);
        $('#button2').fadeOut(0);
        $('#button3').fadeOut(0);
        $('#buttonGeo').fadeOut(0);
		$('#originalInfoBox').hide();
    });

    blackOut(0);
    loadKml(tuvaluStarKml);
}

function groundZero(){
	changeViewPoint(3,3);
	if (mobile == 0){
		setTimeout('landing()',4000);
	} else {
		setTimeout('landing()',4000);
	}
}

function landing(){
	if (urlParameter.location){
		changeViewPoint([urlParameter.location],3);
	} else {
		changeViewPoint(2,3);
	}
	setTimeout('blackOut(1)',3000);
	setTimeout('loadCzml()',3000);
}

//KML、CZMLのロード

function loadKml(url){
	var promise = Cesium.KmlDataSource.load(url);
	promise.then(function(dataSource) {
		viewer.dataSources.add(dataSource);
		setTimeout('groundZero()',1000);
	}).catch(function(error){
		alert('Cannot Load KML Data');
	});
}

function loadCzml(){
	var i = 0;
	var load = setInterval(function(){
		var promise = Cesium.CzmlDataSource.load(czmlDataArray[i].url);
		promise.then(function(dataSource) {
			normalizePhotoBillboards(dataSource);
			viewer.dataSources.add(dataSource);
		}).catch(function(error){
//			alert('CZMLデータが読み込めません');
		});
		i++;
		if (i == czmlDataArray.length){
			clearInterval(load);
/*
			viewer.clock.onTick.addEventListener(function(clock){
				checkTime();
			});
*/
			setTimeout('blackOut(0)',3000);
			setTimeout('widgetsInit()',3000);
//			setTimeout('timeSet()',5000);
		}
	}, 200);
}

//時間セット

/*
var endISO = '2015-12-31T00:00:00+09:00';
var startISO = '2009-01-01T00:00:00+09:00';
var stopISO = '2015-11-01T00:00:00+09:00';

function timeSet(){
	clock = new Cesium.Clock({
		startTime : Cesium.JulianDate.fromIso8601(startISO),
		currentTime : Cesium.JulianDate.fromIso8601(startISO),
		stopTime : Cesium.JulianDate.fromIso8601(endISO),
		clockRange : Cesium.ClockRange.LOOP_STOP
	});
	viewer.clock.startTime = clock.startTime;
	viewer.clock.stopTime = clock.stopTime;
	viewer.clock.currentTime = clock.currentTime;
	viewer.clock.multiplier = 10 * 60 * 60 * 1000;
	viewer.timeline.zoomTo(viewer.clock.startTime, viewer.clock.stopTime);
	viewer.clock.clockRange = clock.clockRange;
	widgetsInit();
}

//タイムカウンター表示

function checkTime(){

	var now = viewer.clock.currentTime;
	var stop = Cesium.JulianDate.fromIso8601(stopISO);
	var nowAndCurrent = Cesium.JulianDate.compare(now, stop);
	if (nowAndCurrent > 0){
		viewer.clock.shouldAnimate = false;
	}

	var nowDate = Cesium.JulianDate.toDate(now);
	var y = nowDate.getFullYear();
	var displayTime = y;
	timeCounter(displayTime);
}

function timeCounter(displayTime){
	var timeCounter = document.getElementById("timeCounter");
	timeCounter.innerHTML = '<p>' + displayTime +'</p>';
}
*/
//視点変更関数

function changeViewPoint(num, delay) {
	var newLat = viewPointsArray[num].lat;
	var newLng = viewPointsArray[num].lng;
	var newHeading = Cesium.Math.toRadians(viewPointsArray[num].heading);
	var newPitch = Cesium.Math.toRadians(viewPointsArray[num].pitch);
	var newRange = viewPointsArray[num].range;

	var center = Cesium.Cartesian3.fromDegrees(newLng, newLat);
	var boundingSphere = new Cesium.BoundingSphere(center, newRange);
	var headingPitchRange = new Cesium.HeadingPitchRange(newHeading, newPitch, newRange);

	viewer.camera.constrainedAxis = Cesium.Cartesian3.UNIT_Z;
	viewer.camera.flyToBoundingSphere(boundingSphere,{
		duration : delay,
		offset : headingPitchRange,
		easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
	});
}

//ジオコード関数

function geocode() {
	var geocoder = new google.maps.Geocoder();
	var input = document.getElementById('inputtext').value;
	geocoder.geocode(
		{ address:input },

		function( results, status ) {
			if( status == google.maps.GeocoderStatus.OK ) {
				var viewportObj = results[0].geometry.viewport;
				var southNorth = viewportObj[Object.keys(viewportObj)[0]];
				var westEast = viewportObj[Object.keys(viewportObj)[1]];

				var south = southNorth[Object.keys(southNorth)[0]];
				var north = southNorth[Object.keys(southNorth)[1]];
				var west = westEast[Object.keys(westEast)[0]];
				var east = westEast[Object.keys(westEast)[1]];
				var rectangle = Cesium.Rectangle.fromDegrees(west, south, east, north);
				viewer.camera.flyTo({
					destination : rectangle,
					easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
				});
			} else {
				alert('Not Found');
			}
		}
		);
}

//現在地に移動する関数

function flyToMyLocation() {
	function fly(position) {
		viewer.camera.flyTo({
			destination : Cesium.Cartesian3.fromDegrees(position.coords.longitude, position.coords.latitude, 5000.0),
			easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
		});
	}
	navigator.geolocation.getCurrentPosition(fly);
}

//顔

function face(){
	location.href = 'index.html';
}

//ヘルプ

function help(){
	window.open('https://tv.mapping.jp/');
}

//ボタン群のイニシャライズ関数

function widgetsInit(){
	$(function() {
//		$('.cesium-viewer-timelineContainer').css('left', '0px');
//		$('.cesium-viewer-timelineContainer').fadeIn("slow");
		$('#button').fadeIn("slow");
		$('#button2').fadeIn("slow");
		$('#button3').fadeIn("slow");
		$('#buttonGeo').fadeIn("slow");
	});
}
</script>
</body>

</html>
