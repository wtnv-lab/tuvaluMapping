<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta name="description" content="'Build the Future with 10,000 Tuvaluans' by NPO Tuvalu Overview is an archiving project of portraits of people in Tuvalu. We made visualization of this archive on Google Earth, and constructed the communication system that users can transmit the message to people in Tuvalu."
	/>
	<meta property="og:image" content="data/screenShot.jpg" />
	<meta property="og:description" content="'Build the Future with 10,000 Tuvaluans' by NPO Tuvalu Overview is an archiving project of portraits of people in Tuvalu. We made visualization of this archive on Google Earth, and constructed the communication system that users can transmit the message to people in Tuvalu."
	/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<title>Tuvalu Visualization Project</title>
	<link rel="SHORTCUT ICON" href="data/favicon.ico">
	<style>
		@import url(Cesium/Widgets/widgets.css);
	</style>
	<link rel="stylesheet" type="text/css" media="all" href="./css/style.css" />
	<link rel="stylesheet" type="text/css" media="all" href="./css/menubutton.css" />
	<script src="js/jquery-2.1.3.min.js"></script>
	<script src="js/slidein.js"></script>
	<script src="Cesium/Cesium.js"></script>
	<script src="http://www.google.com/jsapi"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCc9E-ulJKRVMPyJe_V5sUVNU8kxiDIUtg"></script>
	<script type="text/javascript">
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-55397811-7', 'auto');
		ga('send', 'pageview');
	</script>
</head>

<body>
	<div class="geocode">
		<form action="javascript:geocode()" class="textbox" />
		<input id="inputtext" class="textbox" type="text" value="" placeholder="Geocoding" />
		</form>
	</div>
	<div id="blackOut">
		<img class="loading" src="data/loading.gif">
	</div>
	<div id="cesiumContainer"></div>
	<!--
	<div id="timeCounter"></div>
-->
	<div id="originalInfoBox"></div>
	<div id="button" class="general-button">
		<div class="button-content">
			<span class="icon-font">menu</span>
		</div>
	</div>
	<div id="button2" class="general-button" onclick="photographs();">
		<div class="button-content">
			<span class="icon-font">camera</span>
		</div>
	</div>
	<div id="button3" class="general-button" onclick="help();">
		<div class="button-content">
			<span class="icon-font">help</span>
		</div>
	</div>
	<div id="slide_menu"></div>
	<div id="slide_menu2"></div>
	<div class="sharebutton">
		<ul class="share-buttons">
			<li>
				<a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Ftv.mapping.jp/earth/%2F&t=" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://tv.mapping.jp/earth/'); return false;"><img class="share" src="images/flat_web_icon_set/color/Facebook.png"></a>
			</li>
			<li>
				<a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Ftv.mapping.jp/earth/%2F&text=:%20http%3A%2F%2Ftv.mapping.jp/earth/%2F&via=hwtnv"
					target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + ' http://tv.mapping.jp/earth/'); return false;"><img class="share" src="images/flat_web_icon_set/color/Twitter.png"></a>
			</li>
			<li>
				<a href="https://plus.google.com/share?url=http%3A%2F%2Ftv.mapping.jp/earth/%2F" target="_blank" title="Share on Google+"
					onclick="window.open('https://plus.google.com/share?url=http://tv.mapping.jp/earth/'); return false;"><img class="share" src="images/flat_web_icon_set/color/Google+.png"></a>
			</li>
		</ul>
	</div>
	<script>
//URLパラメータ取得

var urlParameter = new Object;
var pair=location.search.substring(1).split('&');
for(var i=0;pair[i];i++) {
	var parameter = pair[i].split('=');
	urlParameter[parameter[0]]=parameter[1];
}

//オーバレイ用グローバル変数

var openStreetMap = {};
var overlayDataArray=[];

//KML,CZMLファイル指定

var tuvaluStarKml = 'data/star.kml';
var tuvaluTestimonyCzml = 'data/testimonies.czml';
var tuvaluLineCzml = 'data/line.czml';
var tuvaluTestimonyJson = 'data/testimonies.json';
var tuvaluLineJson = 'data/line.json';

//機種判別，画面サイズによる画面レイアウト変更

var mobile = 0;
var smallScreen = 0;

var getDevice = (function(){
	var ua = navigator.userAgent;
	if(ua.indexOf('iPhone') > 0 || ua.indexOf('iPod') > 0 || ua.indexOf('Android') > 0 && ua.indexOf('Mobile') > 0){
		mobile = 1;
	}else if(ua.indexOf('iPad') > 0 || ua.indexOf('Android') > 0){
		mobile = 2;
	}else{
		mobile = 0;
	}
})();

var screenWidth = window.parent.screen.width;
if (screenWidth <= 640) {
	smallScreen = 1;
} else {
	smallScreen = 0;
}

if (smallScreen == 0) {
	$(function() {
		$('#timeCounter').css('bottom','16px');
		$('#timeCounter').css('font-size','22px');
		$('#timeCounter').css('line-height','22px');
	});
}

$(window).on('resize', function(){
	setTimeout('widgetsInit()',100);
});

//画面サイズ調整

if (mobile != 1) {
    setTimeout('resizeWindow()',0);
} else {
    $('.titleImage').css('width','100%');
    setTimeout('resizeWindow()',1000);
}

function resizeWindow(){
    if (mobile != 0){
        var screenWidth = window.innerWidth;
        var screenHeight = window.innerHeight;
        $(function() {
            document.body.style.height = screenHeight;
            $('#cesiumContainer').height(screenHeight);
            $('#blackOut').height(screenHeight);
        });
    }
    setTimeout('loadCesium()',100);
}

//ローディングDIV

var blackOutDiv = document.getElementById("blackOut");

function blackOut(param) {
	if (param == 0){
		$(function() {
			$(blackOutDiv).fadeOut("slow");
		});
	} else {
		$(function() {
			$(blackOutDiv).fadeIn("slow");
		});
	}
}

//視点配列生成

function viewPoints(_label, _lat, _lng, _heading, _pitch, _range) {
	this.label = _label;
	this.lat = _lat;
	this.lng = _lng;
	this.heading = _heading;
	this.pitch = _pitch;
	this.range = _range;
}

var viewPointsArray=[];
viewPointsArray[0]=new viewPoints("Vaitupu",-7.476733,178.679767,0,-25,7200);
viewPointsArray[1]=new viewPoints("Nukulaelae",-9.407985,179.840492,0,-25,10000);
viewPointsArray[2]=new viewPoints("Tuvalu",-7.508104,178.024189,0,-89,1000000);
viewPointsArray[3]=new viewPoints("Earth",-7.508104,178.024189,0,-89,8000000);

var viewPointChangeMenu = document.getElementById('slide_menu');
var dropDownList = "";

for (var i=0; i<viewPointsArray.length; i++) {
	dropDownList = dropDownList + '<li><a href="#" onclick = "changeViewPoint(' + i + ',' + '4.0);return false;">' + viewPointsArray[i].label + '</a></li>';
}

var viewPointChangeMenuHtml = '<ul class="viewpoint">' + dropDownList + '</ul>';
viewPointChangeMenu.innerHTML = viewPointChangeMenuHtml;

//ビューア初期化

var viewer;
var scene;
var ellipsoid;

function loadCesium(){
    viewer = new Cesium.Viewer('cesiumContainer',{
        infoBox:false,
        selectionIndicator:false,
        imageryProvider : new Cesium.ArcGisMapServerImageryProvider({
            url : '//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer',
            enablePickFeatures : false
        }),
        navigationHelpButton : false,
        navigationInstructionsInitiallyVisible : false,
        geocoder:false,
        sceneModePicker:false,
        baseLayerPicker:false,
        timeline: false,
        animation: false,
        scene3DOnly : true
    });

    scene = viewer.scene;
    ellipsoid = scene.globe.ellipsoid;

    //ダブルクリック操作を不可に

    viewer.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

    //devicePixelRatioの設定
    /*
    if(Cesium.FeatureDetection.supportsImageRenderingPixelated()){
        viewer.resolutionScale = window.devicePixelRatio;
    }
    */
    //フォグ
    /*
    var fog = new Cesium.Fog();
    fog.density = 0.003;
    fog.screenSpaceErrorFactor = 100.0;
    */
    //起動シークエンス

    $(function() {
    //			$('.cesium-viewer-animationContainer').fadeOut(0);
    //			$('.cesium-viewer-timelineContainer').fadeOut(0);
    $('#button').fadeOut(0);
    $('#button2').fadeOut(0);
    $('#button3').fadeOut(0);
    $('#buttonGeo').fadeOut(0);
    $('.sharebutton').fadeOut(0);
    $('.geocode').fadeOut(0);
    $('#originalInfoBox').hide();
    });

    blackOut(0);
    loadKml(tuvaluStarKml);
}

function groundZero(){
	changeViewPoint(2,3);
	if (mobile == 0){
		setTimeout('landing()',4000);
	} else {
		$(function() {
			$('.cesium-infoBox').css('height', '420px');
			$('.cesium-infoBox-visible').css('height', '420px');
		});
		setTimeout('landing()',4000);
	}
}

function landing(){
	if (urlParameter.location){
		changeViewPoint([urlParameter.location],3);
	} else {
		changeViewPoint(1,3);
	}
	setTimeout('blackOut(1)',3000);
//			setTimeout('loadJsonTestimony(tuvaluTestimonyJson)',3000);
setTimeout('loadJsonLine(tuvaluLineJson)',3000);
}

//KMLとCZMLのロード

function loadKml(url){
	var promise = Cesium.KmlDataSource.load(url);
	promise.then(function(dataSource) {
		viewer.dataSources.add(dataSource);
		setTimeout('groundZero()',1000);
	}).otherwise(function(error){
		alert('Cannot Load KML Data');
	});
}

function loadCzml(url){
	var promise = Cesium.CzmlDataSource.load(url);
	promise.then(function(dataSource) {
		viewer.dataSources.add(dataSource);
	}).otherwise(function(error){
		alert('Cannot Load CZML Data');
	});
}

//顔アイコン追加

function loadJsonTestimony(fileName){
	var billboards = scene.primitives.add(new Cesium.BillboardCollection());
	var jsonFile = fileName;

	$.getJSON(jsonFile, function(json){
		for(var i in json){
			var id = json[i].id;
			var name = json[i].name;
			var iconUrl = json[i].billboard.image;
			var positions = json[i].position.cartographicDegrees;
			var positionsCartesian3 = Cesium.Cartesian3.fromDegreesArrayHeights(positions)[0];
			var scaleByDistance = new Cesium.NearFarScalar(2.0e3, 1.0, 2.0e5, 0.0);

			var billboardsAdd = billboards.add({
				id: id,
				position : positionsCartesian3,
				image : iconUrl,
				scaleByDistance : scaleByDistance,
				verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
				scale : 1.1
			});
			billboardsAdd.name = name;
/*
					var polylinesAdd = polylines.add({
						id: id,
						positions : polylinePositionsCartesian3,
						width:1,
					});
					polylinesAdd.name = name;
					polylinesAdd.material.uniforms.color.alpha = 0.1;
					*/
				}
			});
	delete jsonFile;
	handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
	handler.setInputAction(
		function(movement){
			var element = scene.pick(movement.position);
			if (element) {
				if (element.id.name != 'line'){
					viewer.entities.add({
						position : element.primitive.position,
						billboard : {
							image : 'data/select.png',
							pixelOffset : new Cesium.Cartesian2(0, -60),
							pixelOffsetScaleByDistance : new Cesium.NearFarScalar(2.0e3, 1, 2.0e5, 0.0),
							horizontalOrigin : Cesium.HorizontalOrigin.CENTER,
							verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
							scale : 0.5,
							color : Cesium.Color.RED,
						}
					});

					var iframeHtml = '<p class="nameAndAge">' + element.primitive.name + '</p><div class="infoBox"><iframe scrolling="no" frameborder="no" sandbox="allow-same-origin allow-top-navigation allow-forms allow-scripts" class="infoBox" src="http://linemap.archiving.jp/doc4iframe.php?id=' + element.primitive.id + '"></iframe></div>';
					$('#originalInfoBox').html(iframeHtml);
					$('#originalInfoBox').fadeIn(500);
				} else {
					$('#originalInfoBox').hide();
				}
			} else {
				$('#originalInfoBox').hide();
			}
		},
		Cesium.ScreenSpaceEventType.LEFT_CLICK);
		setTimeout('blackOut(0)',3000);
		setTimeout('widgetsInit()',3000);
//			loadCzml(tuvaluLineCzml);
//			timeSet();
//			viewer.clock.onTick.addEventListener(function(clock){
//			checkTime();
//			});
}

// ライン追加

function loadJsonLine(fileName){
	var jsonFile = fileName;
	$.getJSON(jsonFile, function(json){
		for(var i in json){
			var positions = json[i].polyline.positions.cartographicDegrees;
			var description = json[i].description;
			var lineColor = Cesium.Color.fromBytes(48,48,255,32);
			var positionsCartesian3 = Cesium.Cartesian3.fromDegreesArrayHeights(positions);
			viewer.entities.add({
				name : 'line',
				description: description,
				polyline : {
					positions : positionsCartesian3,
					width : 2,
					material :lineColor,
				}
			});
		}
	});
	delete jsonFile;
	loadJsonTestimony(tuvaluTestimonyJson);
}

//時間セット
/*
		var endISO = '2015-11-10T00:00:00+09:00';
		var startISO = '1931-06-30T00:00:00+09:00';
		var stopISO = '2014-01-01T00:00:00+09:00';

		function timeSet(){
			clock = new Cesium.Clock({
				startTime : Cesium.JulianDate.fromIso8601(startISO),
				currentTime : Cesium.JulianDate.fromIso8601(startISO),
				stopTime : Cesium.JulianDate.fromIso8601(endISO),
				clockRange : Cesium.ClockRange.LOOP_STOP
			});
			viewer.clock.startTime = clock.startTime;
			viewer.clock.stopTime = clock.stopTime;
			viewer.clock.currentTime = clock.currentTime;
			viewer.clock.multiplier = 10 * 60 * 60 * 10000;
			viewer.timeline.zoomTo(viewer.clock.startTime, viewer.clock.stopTime);
			viewer.clock.clockRange = clock.clockRange;
			widgetsInit();
		}

//タイムカウンター表示

		function checkTime(){

			var now = viewer.clock.currentTime;
			var stop = Cesium.JulianDate.fromIso8601(stopISO);
			var nowAndCurrent = Cesium.JulianDate.compare(now, stop);
			if (nowAndCurrent > 0){
				viewer.clock.shouldAnimate = false;
			}

			var nowDate = Cesium.JulianDate.toDate(now);
			var y = nowDate.getFullYear();
			var displayTime = y;
			timeCounter(displayTime);
		}

		function timeCounter(displayTime){
			var timeCounter = document.getElementById("timeCounter");
			timeCounter.innerHTML = '<p>' + displayTime +'</p>';
		}
		*/
//視点変更関数

function changeViewPoint(num, delay) {
	var newLat = viewPointsArray[num].lat;
	var newLng = viewPointsArray[num].lng;
	var newHeading = Cesium.Math.toRadians(viewPointsArray[num].heading);
	var newPitch = Cesium.Math.toRadians(viewPointsArray[num].pitch);
	var newRange = viewPointsArray[num].range;

	var center = Cesium.Cartesian3.fromDegrees(newLng, newLat);
	var boundingSphere = new Cesium.BoundingSphere(center, newRange);
	var headingPitchRange = new Cesium.HeadingPitchRange(newHeading, newPitch, newRange);

	viewer.camera.constrainedAxis = Cesium.Cartesian3.UNIT_Z;
	viewer.camera.flyToBoundingSphere(boundingSphere,{
		duration : delay,
		offset : headingPitchRange,
		easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
	});
}

//ジオコード関数

function geocode() {
	var geocoder = new google.maps.Geocoder();
	var input = document.getElementById('inputtext').value;
	geocoder.geocode(
		{ address:input },

		function( results, status ) {
			if( status == google.maps.GeocoderStatus.OK ) {
				var viewportObj = results[0].geometry.viewport;
				var southNorth = viewportObj[Object.keys(viewportObj)[0]];
				var westEast = viewportObj[Object.keys(viewportObj)[1]];

				var south = southNorth[Object.keys(southNorth)[0]];
				var north = southNorth[Object.keys(southNorth)[1]];
				var west = westEast[Object.keys(westEast)[0]];
				var east = westEast[Object.keys(westEast)[1]];
				var rectangle = Cesium.Rectangle.fromDegrees(west, south, east, north);
				viewer.camera.flyTo({
					destination : rectangle,
					easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
				});
			} else {
				alert('Not Found');
			}
		}
		);
}

//現在地に移動する関数

function flyToMyLocation() {
	function fly(position) {
		viewer.camera.flyTo({
			destination : Cesium.Cartesian3.fromDegrees(position.coords.longitude, position.coords.latitude, 5000.0),
			easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
		});
	}
	navigator.geolocation.getCurrentPosition(fly);
}

//写真

function photographs(){
	location.href = 'photographs.html';
}

//ヘルプ

function help(){
	window.open('http://tv.mapping.jp/');
}

//線をクリックした時はinfoBoxを非表示にする
/*
		var scene = viewer.scene;
		handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
		handler.setInputAction(
			function(movement){
				var childNodesLength = 0;
				var element = scene.pick(movement.position);
				if (element) {
					setTimeout(function(){
						var iframeContents = $('iframe:first').contents().find('.cesium-infoBox-description');
						var childNodesLength = iframeContents[0].childNodes.length;
						if (childNodesLength == 0){
							$(function(){
								$('.cesium-infoBox-visible').hide();
							});
							viewer.selectedEntity = undefined;
						} else {
							$(function(){
								$('.cesium-infoBox-visible').show();
							});
						}
					},1);
				}
			},
		Cesium.ScreenSpaceEventType.LEFT_CLICK);
*/
//ボタン群のイニシャライズ関数

function widgetsInit(){
	$(function() {
//				$('.cesium-viewer-timelineContainer').css('left', '0px');
//				$('.cesium-viewer-timelineContainer').fadeIn("slow");
$('#button').fadeIn("slow");
$('.geocode').fadeIn("slow");
$('#button2').fadeIn("slow");
$('#button3').fadeIn("slow");
$('#buttonGeo').fadeIn("slow");
if (mobile != 1){
	$('.sharebutton').fadeIn("slow");
}
});
}
</script>
</body>

</html>
